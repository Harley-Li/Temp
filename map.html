<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å½“å‰ä½ç½® - åœ°å›¾ App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">

    <!-- Leaflet CSS - å¿…é¡»å¼•å…¥ï¼Œç”¨äºåœ°å›¾æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAo9TchQCOfKKCPzzgpMGymPIQzSgkfKKFCvgYhY="
        crossorigin="anonymous"/>

    <style>
        /* ==================================================================== */
        /* CSS Styling */
        /* ==================================================================== */
        :root {
            --primary-color: #6c63ff; /* ç´«è‰² */
            --accent-color: #4CAF50; /* ç»¿è‰² */
            --error-color: #D32F2F; /* çº¢è‰² */
            --bg-color: #f7f9fc; /* æµ…ç°è‰²èƒŒæ™¯ */
            --card-bg-color: #ffffff;
            --text-color: #333;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            width: 100%;
            text-align: center;
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 700;
        }

        .map-app-container {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 800px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-status {
            min-height: 200px; /* ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºçŠ¶æ€ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            text-align: center;
            color: #666;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease-in-out;
        }

        .map-status.loading {
            background-color: #eef2f6;
            color: var(--primary-color);
        }

        .map-status.error {
            background-color: #ffebe6; /* æµ…çº¢èƒŒæ™¯ */
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .map-status .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .map-status p {
            margin: 5px 0;
            line-height: 1.5;
        }

        /* åœ°å›¾å®¹å™¨ */
        #map {
            height: 500px; /* è®¾ç½®åœ°å›¾é«˜åº¦ï¼Œå¯è°ƒæ•´ */
            width: 100%;
            border-radius: var(--border-radius);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden; /* ç¡®ä¿åœ°å›¾åœ†è§’ */
            display: none; /* åˆå§‹éšè—ï¼ŒåŠ è½½æˆåŠŸåæ˜¾ç¤º */
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        footer {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
            color: #888;
            font-size: 0.9em;
            width: 100%;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* ç§»åŠ¨è®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            .map-app-container {
                width: 95%;
                padding: 15px;
            }
            #map {
                height: 400px; /* ç§»åŠ¨è®¾å¤‡ä¸Šå¯ä»¥é€‚å½“é™ä½é«˜åº¦ */
            }
            .map-status {
                font-size: 1em;
                min-height: 150px;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ“ æˆ‘çš„å½“å‰ä½ç½®</h1>
    </header>

    <div class="map-app-container">
        <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ (åŠ è½½ä¸­/é”™è¯¯) -->
        <div id="map-status" class="map-status loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠªåŠ›è·å–æ‚¨çš„å½“å‰ä½ç½®...</p>
            <p style="font-size: 0.9em; color: #888;">è¯·å…è®¸æµè§ˆå™¨è®¿é—®æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚</p>
        </div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div id="map"></div>
    </div>

    <footer>
        <p>&copy; 2023 å½“å‰ä½ç½®åœ°å›¾ App | åŸºäº <a href="https://leafletjs.com/" target="_blank">Leaflet</a> å’Œ <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a></p>
    </footer>

    <!-- Leaflet JavaScript - å¿…é¡»åœ¨è‡ªå®šä¹‰ JS ä¹‹å‰å¼•å…¥ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6qqzJRzvaTMkjkGFHR2/a7Trh/3WSyFGmvYwkQ14="
        crossorigin=""></script>

    <script>
        /* ==================================================================== */
        /* JavaScript Logic */
        /* ==================================================================== */

        // è§£å†³ Leaflet é»˜è®¤å›¾æ ‡åœ¨æŸäº›ç¯å¢ƒä¸­æ— æ³•æ˜¾ç¤ºçš„é—®é¢˜ (CDN è·¯å¾„)
        // è¿™æ˜¯å› ä¸º Leaflet é»˜è®¤æŸ¥æ‰¾å›¾æ ‡çš„è·¯å¾„æ˜¯ç›¸å¯¹çš„ï¼Œè€Œæœ‰æ—¶æ„å»ºå·¥å…·æˆ–æœåŠ¡å™¨é…ç½®ä¼šå¯¼è‡´è·¯å¾„é”™è¯¯ã€‚
        // é€šè¿‡åˆå¹¶é€‰é¡¹ï¼Œå¼ºåˆ¶ Leaflet ä½¿ç”¨ CDN è·¯å¾„ï¼Œç¡®ä¿å›¾æ ‡æ­£ç¡®æ˜¾ç¤ºã€‚
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        });

        // DOM å…ƒç´ å¼•ç”¨
        const mapDiv = document.getElementById('map');
        const mapStatusDiv = document.getElementById('map-status');

        let map = null; // Leaflet åœ°å›¾å®ä¾‹
        let currentMarker = null; // å½“å‰ä½ç½®æ ‡è®°å®ä¾‹

        // é»˜è®¤åœ°å›¾ä¸­å¿ƒ (ä¾‹å¦‚ï¼šå·´é»ï¼Œå¦‚æœåœ¨è·å–ç”¨æˆ·ä½ç½®å‰éœ€è¦æ˜¾ç¤º)
        const defaultMapCenter = [48.8566, 2.3522]; // å·´é»
        const defaultZoom = 13; // é»˜è®¤ç¼©æ”¾çº§åˆ«

        /**
         * æ˜¾ç¤ºåœ°å›¾çŠ¶æ€ä¿¡æ¯
         * @param {string} type - 'loading', 'error', 'success'
         * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
         * @param {string} [subMessage=''] - æ¬¡è¦æ¶ˆæ¯
         */
        function showMapStatus(type, message, subMessage = '') {
            mapStatusDiv.className = `map-status ${type}`; // æ›´æ–°ç±»åä»¥åº”ç”¨æ ·å¼
            let content = '';

            if (type === 'loading') {
                content = `<div class="spinner"></div><p>${message}</p><p style="font-size: 0.9em; color: #888;">${subMessage}</p>`;
                mapDiv.style.display = 'none'; // åŠ è½½æ—¶éšè—åœ°å›¾
            } else if (type === 'error') {
                content = `<p style="font-weight: bold;">ğŸ˜¥ æ— æ³•è·å–ä½ç½®ä¿¡æ¯:</p><p>${message}</p><p style="font-size: 0.9em; margin-top: 10px;">${subMessage}</p>`;
                mapDiv.style.display = 'none'; // é”™è¯¯æ—¶éšè—åœ°å›¾
            } else if (type === 'success') {
                // æˆåŠŸæ—¶éšè—çŠ¶æ€é¢æ¿ï¼Œæ˜¾ç¤ºåœ°å›¾
                mapStatusDiv.style.display = 'none';
                mapDiv.style.display = 'block';
                return; // ä¸æ›´æ–°å†…å®¹ï¼Œå› ä¸ºé¢æ¿ä¼šè¢«éšè—
            }
            mapStatusDiv.innerHTML = content;
            mapStatusDiv.style.display = 'flex'; // ç¡®ä¿çŠ¶æ€é¢æ¿å¯è§
        }

        /**
         * åˆå§‹åŒ–åœ°å›¾
         */
        function initMap() {
            // å¦‚æœåœ°å›¾å·²ç»åˆå§‹åŒ–ï¼Œåˆ™ä¸å†é‡å¤åˆå§‹åŒ–
            if (map) return;

            map = L.map(mapDiv).setView(defaultMapCenter, defaultZoom);

            // æ·»åŠ  OpenStreetMap ç“¦ç‰‡å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            getLocation(); // å°è¯•è·å–ç”¨æˆ·ä½ç½®
        }

        /**
         * è·å–å½“å‰åœ°ç†ä½ç½®
         */
        function getLocation() {
            showMapStatus('loading', 'æ­£åœ¨åŠªåŠ›è·å–æ‚¨çš„å½“å‰ä½ç½®...', 'è¯·å…è®¸æµè§ˆå™¨è®¿é—®æ‚¨çš„åœ°ç†ä½ç½®ä¿¡æ¯ã€‚');

            if (!navigator.geolocation) {
                showMapStatus('error', 'æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡ã€‚', 'è¯·å°è¯•ä½¿ç”¨æ”¯æŒæ­¤åŠŸèƒ½çš„ç°ä»£æµè§ˆå™¨ã€‚');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // ä½ç½®ç²¾åº¦ï¼Œå•ä½ç±³

                    showMapStatus('success'); // éšè—çŠ¶æ€é¢æ¿ï¼Œæ˜¾ç¤ºåœ°å›¾

                    // æ›´æ–°åœ°å›¾è§†å›¾åˆ°å½“å‰ä½ç½®å¹¶å¹³æ»‘è¿‡æ¸¡
                    map.flyTo([lat, lng], defaultZoom + 2, { // ç¼©æ”¾çº§åˆ«ç•¥é«˜ï¼Œæ›´èšç„¦
                        animate: true,
                        duration: 1.5 // åŠ¨ç”»æ—¶é•¿1.5ç§’
                    });

                    // æ·»åŠ æˆ–æ›´æ–°æ ‡è®°
                    if (currentMarker) {
                        currentMarker.setLatLng([lat, lng]);
                    } else {
                        currentMarker = L.marker([lat, lng]).addTo(map);
                    }

                    // è®¾ç½®æ ‡è®°çš„å¼¹å‡ºä¿¡æ¯
                    const popupContent = `
                        <b>æ‚¨å½“å‰æ‰€åœ¨çš„ä½ç½®ï¼</b><br>
                        çº¬åº¦: ${lat.toFixed(6)}<br>
                        ç»åº¦: ${lng.toFixed(6)}<br>
                        <small>ç²¾åº¦: Â±${accuracy.toFixed(2)} ç±³</small>
                    `;
                    currentMarker.bindPopup(popupContent).openPopup();

                    // å¯ä»¥æ·»åŠ ä¸€ä¸ªåœˆï¼Œè¡¨ç¤ºä½ç½®ç²¾åº¦èŒƒå›´
                    L.circle([lat, lng], {
                        radius: accuracy, // åŠå¾„ä¸ºç²¾åº¦å€¼
                        color: 'var(--primary-color)',
                        fillColor: 'var(--primary-color)',
                        fillOpacity: 0.1,
                        weight: 2
                    }).addTo(map);

                },
                (error) => {
                    let errorMessage = 'æœªçŸ¥é”™è¯¯';
                    let subMessage = 'è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'æ‚¨å·²æ‹’ç»åœ°ç†ä½ç½®æƒé™ã€‚';
                            subMessage = 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸å®šä½ï¼Œç„¶åé‡è¯•ã€‚';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ã€‚';
                            subMessage = 'è¿™å¯èƒ½æ˜¯å› ä¸ºæ‚¨çš„è®¾å¤‡æ²¡æœ‰è¿æ¥åˆ°Wi-Fiæˆ–GPSä¿¡å·è¾ƒå¼±ã€‚';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'è·å–ä½ç½®ä¿¡æ¯è¶…æ—¶ã€‚';
                            subMessage = 'è¯·ç¡®ä¿æ‚¨æœ‰ç¨³å®šçš„ç½‘ç»œè¿æ¥ï¼Œå¹¶é‡è¯•ã€‚';
                            break;
                        default:
                            errorMessage = `è·å–ä½ç½®æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`;
                            break;
                    }
                    showMapStatus('error', errorMessage, subMessage);
                },
                {
                    enableHighAccuracy: true, // å°è¯•è·å–é«˜ç²¾åº¦ä½ç½®
                    timeout: 10000,           // 10ç§’åè¶…æ—¶
                    maximumAge: 0             // ä¸ä½¿ç”¨ç¼“å­˜ä½ç½®
                }
            );
        }

        // å½“ DOM å®Œå…¨åŠ è½½åï¼Œåˆå§‹åŒ–åœ°å›¾å’Œè·å–ä½ç½®
        document.addEventListener('DOMContentLoaded', initMap);

    </script>
</body>
</html>